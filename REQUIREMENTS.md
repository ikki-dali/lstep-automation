# 📋 要件定義書 - LSTEP CSV自動エクスポートツール

**作成日**: 2025年1月  
**バージョン**: 1.0  
**ステータス**: Draft

---

## 目次

1. [プロジェクト概要](#プロジェクト概要)
2. [現状の問題点](#現状の問題点)
3. [目標](#目標)
4. [機能要件](#機能要件)
5. [非機能要件](#非機能要件)
6. [制約事項](#制約事項)
7. [エラーケースと対処](#エラーケースと対処)
8. [成功基準](#成功基準)
9. [テストケース](#テストケース)

---

## 1. プロジェクト概要

### 1.1 背景

LステップからCSVデータを定期的に取得し、Googleスプレッドシートにアップロードする業務を自動化する。

現在、Chrome拡張機能で実装しているが、**安定性に課題**があり、予期しないエラーが頻発している。

### 1.2 目的

- **安定性の向上**: 成功率を60% → 85%以上に改善
- **デバッグの容易化**: エラー原因の特定を迅速化
- **保守性の向上**: メンテナンスしやすいコード構造
- **運用の効率化**: 手動介入を最小限に

### 1.3 スコープ

**対象範囲:**
- LステップからのCSV自動ダウンロード
- Googleスプレッドシートへの自動アップロード
- 定期実行の設定
- エラー通知

**対象外:**
- データの加工・分析
- 他のツールとの連携（将来対応可）
- リアルタイム同期

---

## 2. 現状の問題点

### 2.1 Chrome拡張機能の課題

| 問題 | 影響 | 頻度 |
|------|------|------|
| Service Workerのライフサイクル問題 | 処理が途中で止まる | 週2-3回 |
| タブ管理の複雑さ | 状態管理が不安定 | 週1-2回 |
| エラー原因の不明確さ | デバッグに時間がかかる | 毎回 |
| DOM要素の検索失敗 | ボタンが見つからない | 週1回 |
| タイミング問題 | 要素の読み込み待機が不十分 | 週2-3回 |
| セッション管理の不安定さ | 再ログインが必要 | 月1-2回 |

### 2.2 具体的なエラー例

```
❌ "今までできていたことが急にできなくなる"
   → 原因: DOM要素の検索タイミング、Service Worker停止

❌ "ジョブが途中で止まる"
   → 原因: Service Workerの予期しない停止

❌ "エラーが出ても何が悪いか分からない"
   → 原因: ログが不十分、スクリーンショットなし
```

### 2.3 ユーザーの声

> 「朝来たら失敗していて、何が原因か分からない」  
> 「再実行すると成功することもあるが、不安定」  
> 「手動で実行し直すのが面倒」

---

## 3. 目標

### 3.1 定量目標

| 指標 | 現状 | 目標 |
|------|------|------|
| **成功率** | 60% | **85%以上** |
| **平均処理時間** | 2-5分 | **30秒-1分** |
| **エラー原因特定時間** | 10-30分 | **5分以内** |
| **月間手動介入回数** | 8-12回 | **2回以下** |
| **セッション切れ** | 月1-2回 | **月0-1回** |

### 3.2 定性目標

- ✅ エラー時に「何が起きたか」が一目で分かる
- ✅ 失敗しても自動リトライで復旧できる
- ✅ メンテナンスが容易（コードが読みやすい）
- ✅ 新メンバーでも使い方が理解できる

---

## 4. 機能要件

### 4.1 MUST（必須機能）

#### M-1: CSV自動ダウンロード
- Lステップにログイン（セッション保持）
- 指定プリセットを選択
- CSV生成リクエスト
- ダウンロード完了を検知

#### M-2: Googleスプレッドシート連携
- Google Sheets APIで認証
- 指定シートのデータをクリア
- CSVデータをアップロード
- アップロード完了を確認

#### M-3: エラーハンドリング
- タイムアウト検知
- 要素が見つからない場合の検知
- ネットワークエラーの検知
- 自動リトライ（最大3回）

#### M-4: ログ記録
- 処理の各ステップをログに記録
- エラー発生時の詳細ログ
- 日付ごとにログファイル分割

#### M-5: セッション管理
- ログイン状態の保存（Cookie）
- セッション切れの検知
- 再ログインの案内

### 4.2 SHOULD（推奨機能）

#### S-1: スクリーンショット保存
- エラー時に画面を自動保存
- ステップごとのスクリーンショット（デバッグ用）

#### S-2: 複数クライアント対応
- 設定ファイルで複数クライアントを管理
- 順次実行

#### S-3: 通知機能
- 完了通知（ターミナル）
- エラー通知（ターミナル + ログ）

### 4.3 COULD（将来対応）

#### C-1: Slack通知
- 成功/失敗をSlackに通知

#### C-2: メール通知
- エラー時にメール送信

#### C-3: Webダッシュボード
- 実行履歴の可視化
- リアルタイム進捗表示

#### C-4: 並列実行
- 複数クライアントを同時処理

---

## 5. 非機能要件

### 5.1 安定性

| 項目 | 要件 |
|------|------|
| **成功率** | 85%以上 |
| **リトライ** | 失敗時は3回まで自動リトライ |
| **タイムアウト** | 各ステップ60秒、全体5分 |
| **エラー回復** | 一時的なエラーは自動復旧 |

### 5.2 パフォーマンス

| 項目 | 要件 |
|------|------|
| **処理時間** | 平均30秒-1分 |
| **最大処理時間** | 5分以内 |
| **メモリ使用量** | 500MB以下 |
| **CPU使用率** | 平常時50%以下 |

### 5.3 保守性

- **コードの可読性**: 関数は1つ50行以内
- **コメント**: 複雑な処理には日本語コメント
- **モジュール分割**: 機能ごとにファイル分割
- **設定外部化**: ハードコードせず設定ファイル使用

### 5.4 セキュリティ

- **認証情報**: 設定ファイルに保存（GitHubはプライベート）
- **ログ**: 個人情報をマスキング
- **アクセス制御**: 社内メンバーのみアクセス可能

### 5.5 互換性

- **OS**: macOS 12以上（Intel/M1/M2対応）
- **Node.js**: v18以上
- **ブラウザ**: Chromium（Puppeteer内蔵）

---

## 6. 制約事項

### 6.1 技術的制約

| 制約 | 理由 | 対応 |
|------|------|------|
| Lステップの仕様変更 | UIが変わると動かない | 定期的なメンテナンス |
| セッションの有効期限 | 期限切れでログイン必要 | Cookie保存 + 再ログイン機能 |
| Google API制限 | 1分あたりの読み書き制限 | リクエスト間隔調整 |
| CSV生成時間 | サーバー側の処理時間に依存 | 長めのタイムアウト設定 |

### 6.2 運用上の制約

- **初回セットアップ**: 手動ログインが必要
- **定期メンテナンス**: 月1回の動作確認推奨
- **エラー対応**: 完全自動化は困難、監視が必要

### 6.3 できないこと

- ❌ Lステップの仕様変更への自動対応
- ❌ 複雑なデータ加工・分析
- ❌ リアルタイム同期（定期実行のみ）
- ❌ 他のツールとの自動連携（API未対応）

---

## 7. エラーケースと対処

### 7.1 想定エラーケース

| エラーケース | 原因 | 対処方法 | 優先度 |
|-------------|------|---------|--------|
| ログインセッション切れ | Cookie期限切れ | 再ログイン案内 | 高 |
| プリセットが見つからない | 名前の不一致、削除 | エラーログ + 設定確認案内 | 高 |
| CSV生成タイムアウト | サーバー処理遅延 | タイムアウト延長 + リトライ | 高 |
| ダウンロード失敗 | ネットワークエラー | リトライ | 中 |
| Google Sheets API エラー | 認証・権限・制限 | 詳細エラーログ + リトライ | 高 |
| DOM要素が見つからない | ページ構造変更 | 複数セレクタ戦略 + スクショ | 高 |
| ページ読み込みタイムアウト | ネットワーク遅延 | networkIdleWait + リトライ | 中 |
| ブラウザクラッシュ | メモリ不足、バグ | 自動再起動 + 通知 | 低 |

### 7.2 エラー時の動作

```
エラー発生
  ↓
スクリーンショット保存
  ↓
詳細ログ記録
  ↓
リトライ判定
  ├─ Yes → 5秒待機 → 再実行（最大3回）
  └─ No  → エラー通知 → 処理終了
```

### 7.3 エラー通知の内容

- **エラーメッセージ**: 何が起きたか
- **発生時刻**: いつ起きたか
- **処理ステップ**: どこで失敗したか
- **スクリーンショット**: 画面の状態
- **ログファイルパス**: 詳細確認用

---

## 8. 成功基準

### 8.1 受け入れ条件

以下の条件を**すべて満たす**こと：

#### ✅ 機能面
- [ ] 正常系: プリセット選択 → CSV生成 → ダウンロード → アップロード が完了する
- [ ] 複数クライアント: 2つ以上の設定で連続実行できる
- [ ] リトライ: 一時的なエラーから自動復旧できる
- [ ] ログイン保持: Cookie保存で再ログイン不要（30日間）

#### ✅ 安定性
- [ ] 連続10回実行して、**8回以上成功**（成功率80%以上）
- [ ] エラー発生時、**100%スクリーンショットが保存される**
- [ ] タイムアウトエラーが発生しても、**リトライで復旧できる**

#### ✅ デバッグ性
- [ ] エラー時、**ログだけで原因が特定できる**
- [ ] スクリーンショットで**画面の状態が分かる**
- [ ] エラーから原因特定まで**5分以内**

#### ✅ 保守性
- [ ] 新メンバーが**README.mdだけでセットアップできる**
- [ ] エラー発生時の対処法が**ドキュメント化されている**
- [ ] コードに**適切なコメントがある**

### 8.2 性能基準

| 項目 | 基準 | 測定方法 |
|------|------|----------|
| 処理時間 | 平均1分以内 | 10回実行の平均 |
| 成功率 | 85%以上 | 20回実行の成功率 |
| エラー復旧率 | 70%以上 | リトライでの復旧率 |
| ログ出力時間 | 1秒以内 | ログ書き込み完了まで |

---

## 9. テストケース

### 9.1 正常系テスト

| No | テストケース | 期待結果 |
|----|-------------|----------|
| T-1 | 初回セットアップ → ログイン | Cookie保存成功 |
| T-2 | 1クライアント実行 | CSV取得 → アップロード成功 |
| T-3 | 2クライアント連続実行 | 両方とも成功 |
| T-4 | 定期実行（cron） | 指定時刻に自動実行 |
| T-5 | ログ確認 | 各ステップがログに記録される |

### 9.2 異常系テスト

| No | テストケース | 期待結果 |
|----|-------------|----------|
| E-1 | ネットワーク切断時 | タイムアウト → リトライ → エラー通知 |
| E-2 | 存在しないプリセット名 | エラーログ + スクリーンショット |
| E-3 | 無効なSheet ID | Google API エラー + 詳細ログ |
| E-4 | セッション期限切れ | エラー通知 + 再ログイン案内 |
| E-5 | 処理中にブラウザクラッシュ | エラー検知 + 通知 |
| E-6 | CSV生成に5分以上 | タイムアウト + リトライ |

### 9.3 境界値テスト

| No | テストケース | 期待結果 |
|----|-------------|----------|
| B-1 | 大容量CSV（10MB以上） | 正常にアップロード |
| B-2 | 10,000行以上のデータ | パフォーマンス低下なし |
| B-3 | 特殊文字を含むプリセット名 | 正常に検索・選択 |
| B-4 | 同時に3クライアント実行 | 順次処理で全て成功 |

### 9.4 継続運用テスト

| No | テストケース | 期待結果 |
|----|-------------|----------|
| C-1 | 1週間の連続実行（1日3回） | 成功率85%以上 |
| C-2 | 1ヶ月後のログイン状態 | Cookie有効でログイン不要 |
| C-3 | ログファイル蓄積（30日） | 古いログは自動削除 |

---

## 10. 開発フェーズ

### Phase 1: 基本機能実装（1週間）
- [ ] ブラウザ自動操作
- [ ] CSV取得
- [ ] Google Sheets連携
- [ ] 基本ログ機能

### Phase 2: 安定化（1週間）
- [ ] エラーハンドリング強化
- [ ] リトライ機能
- [ ] スクリーンショット保存
- [ ] 詳細ログ

### Phase 3: テスト・改善（1週間）
- [ ] テストケース実行
- [ ] パフォーマンス最適化
- [ ] ドキュメント整備
- [ ] デバッグツール

### Phase 4: 運用準備（3日）
- [ ] 定期実行設定
- [ ] 監視設定
- [ ] チームへの説明会

---

## 11. リスクと対策

| リスク | 影響度 | 確率 | 対策 |
|--------|--------|------|------|
| Lステップ仕様変更 | 高 | 中 | 月次メンテナンス、複数セレクタ |
| Google API制限 | 中 | 低 | リクエスト間隔調整 |
| セッション切れ | 中 | 中 | Cookie保存 + 通知 |
| ブラウザバージョンアップ | 低 | 低 | Puppeteer自動更新 |

---

## 12. 用語集

| 用語 | 説明 |
|------|------|
| Puppeteer | Chromeを自動操作するNode.jsライブラリ |
| headless | ブラウザを画面表示せずに実行するモード |
| networkIdle | ネットワーク通信が落ち着いた状態 |
| Cookie | ブラウザに保存されるログイン情報 |
| cron | macOS/Linuxの定期実行機能 |

---

**承認欄**

| 役割 | 氏名 | 日付 | 承認 |
|------|------|------|------|
| 作成者 | - | 2025-01-XX | - |
| レビュー | - | - | - |
| 承認者 | - | - | - |

---

**変更履歴**

| 日付 | バージョン | 変更内容 | 変更者 |
|------|-----------|---------|--------|
| 2025-01-XX | 1.0 | 初版作成 | - |