#!/bin/bash

# è‰²ã®å®šç¾©
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

echo ""
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘                                                            â•‘"
echo "â•‘        LSTEP CSVè‡ªå‹•ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒ„ãƒ¼ãƒ« ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—          â•‘"
echo "â•‘                                                            â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# ========================================
# Step 1: npm install
# ========================================
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${GREEN}Step 1/5: ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«${NC}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

if [ -d "node_modules" ]; then
  echo -e "${YELLOW}âš ï¸  node_modules ãŒæ—¢ã«å­˜åœ¨ã—ã¾ã™${NC}"
  read -p "å†ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã‹ï¼Ÿ (y/n): " reinstall
  if [[ $reinstall == "y" || $reinstall == "Y" ]]; then
    echo "ðŸ“¦ ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’å†ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
    npm install
  else
    echo "ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸ"
  fi
else
  echo "ðŸ“¦ ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
  npm install
fi

echo ""
echo -e "${GREEN}âœ… Step 1 å®Œäº†${NC}"
echo ""

# ========================================
# Step 2: Google Sheets API èªè¨¼è¨­å®š
# ========================================
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${GREEN}Step 2/5: Google Sheets API èªè¨¼è¨­å®š${NC}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

if [ -f "config/credentials.json" ]; then
  echo -e "${GREEN}âœ… config/credentials.json ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ${NC}"
  
  # ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æŠ½å‡º
  SERVICE_ACCOUNT_EMAIL=$(grep -o '"client_email": "[^"]*"' config/credentials.json | sed 's/"client_email": "\(.*\)"/\1/')
  
  echo ""
  echo -e "${YELLOW}ðŸ“§ ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹:${NC}"
  echo -e "${BLUE}   ${SERVICE_ACCOUNT_EMAIL}${NC}"
  echo ""
  echo -e "${YELLOW}ðŸ“ é‡è¦: ã“ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«æ‹›å¾…ã—ã¦ãã ã•ã„ï¼${NC}"
  echo ""
  echo "   æ‰‹é †:"
  echo "   1. ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’é–‹ã"
  echo "   2. å³ä¸Šã®ã€Œå…±æœ‰ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯"
  echo "   3. ä¸Šè¨˜ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’è¿½åŠ "
  echo "   4. æ¨©é™ã‚’ã€Œç·¨é›†è€…ã€ã«è¨­å®š"
  echo ""
  read -p "æ‹›å¾…ãŒå®Œäº†ã—ãŸã‚‰ Enter ã‚’æŠ¼ã—ã¦ãã ã•ã„..."
  
else
  echo -e "${RED}âŒ config/credentials.json ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“${NC}"
  echo ""
  echo "ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ãƒãƒ¼ãƒ ã‹ã‚‰å…±æœ‰ã•ã‚Œã¦ã„ã‚‹ã¯ãšã§ã™ã€‚"
  echo "Slack/Teamsãªã©ã§ã€Œcredentials.jsonã€ã‚’æ¤œç´¢ã—ã¦ã¿ã¦ãã ã•ã„ã€‚"
  echo ""
  echo "ðŸ“‚ é…ç½®å ´æ‰€: $(pwd)/config/credentials.json"
  echo ""
  read -p "ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é…ç½®ã—ãŸã‚‰ Enter ã‚’æŠ¼ã—ã¦ãã ã•ã„..."
  
  if [ ! -f "config/credentials.json" ]; then
    echo ""
    echo -e "${RED}âŒ ã¾ã ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“${NC}"
    echo "ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é…ç½®ã—ã¦ã‹ã‚‰ã€å†åº¦ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚"
    exit 1
  fi
  
  # ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æŠ½å‡º
  SERVICE_ACCOUNT_EMAIL=$(grep -o '"client_email": "[^"]*"' config/credentials.json | sed 's/"client_email": "\(.*\)"/\1/')
  
  echo ""
  echo -e "${GREEN}âœ… ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèªã—ã¾ã—ãŸ${NC}"
  echo ""
  echo -e "${YELLOW}ðŸ“§ ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹:${NC}"
  echo -e "${BLUE}   ${SERVICE_ACCOUNT_EMAIL}${NC}"
  echo ""
  echo -e "${YELLOW}ðŸ“ ã“ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«æ‹›å¾…ã—ã¦ãã ã•ã„ï¼${NC}"
  echo ""
  read -p "æ‹›å¾…ãŒå®Œäº†ã—ãŸã‚‰ Enter ã‚’æŠ¼ã—ã¦ãã ã•ã„..."
fi

echo ""
echo -e "${GREEN}âœ… Step 2 å®Œäº†${NC}"
echo ""

# ========================================
# Step 3: ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè¨­å®š
# ========================================
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${GREEN}Step 3/5: ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè¨­å®š${NC}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

if [ -f "config/settings.json" ]; then
  echo -e "${YELLOW}âš ï¸  config/settings.json ãŒæ—¢ã«å­˜åœ¨ã—ã¾ã™${NC}"
  read -p "ä¸Šæ›¸ãã—ã¦æ–°ã—ãè¨­å®šã—ã¾ã™ã‹ï¼Ÿ (y/n): " overwrite
  if [[ $overwrite != "y" && $overwrite != "Y" ]]; then
    echo "æ—¢å­˜ã®è¨­å®šã‚’ä½¿ç”¨ã—ã¾ã™"
    echo ""
    echo -e "${GREEN}âœ… Step 3 å®Œäº†${NC}"
    echo ""
    # Step 4ã¸
    read -p "Enter ã‚’æŠ¼ã—ã¦æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã¸..."
  else
    rm config/settings.json
  fi
fi

if [ ! -f "config/settings.json" ]; then
  echo "ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæƒ…å ±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"
  echo ""
  
  # ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå
  read -p "ðŸ“ ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåï¼ˆä¾‹: FDæŽ¡ç”¨ï¼‰: " CLIENT_NAME
  
  # ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆURL
  echo ""
  echo "ðŸ“ Lã‚¹ãƒ†ãƒƒãƒ—ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒšãƒ¼ã‚¸ URL"
  echo "   ä¾‹: https://manager.linestep.net/line/exporter/xxxxx/list"
  read -p "   URL: " EXPORTER_URL
  
  # ãƒ—ãƒªã‚»ãƒƒãƒˆå
  echo ""
  echo "ðŸ“‹ ãƒ—ãƒªã‚»ãƒƒãƒˆåï¼ˆLã‚¹ãƒ†ãƒƒãƒ—ã§è¨­å®šã—ãŸåå‰ï¼‰"
  echo "   âš ï¸  å®Œå…¨ä¸€è‡´ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼ˆå¤§æ–‡å­—å°æ–‡å­—ã€ã‚¹ãƒšãƒ¼ã‚¹å«ã‚€ï¼‰"
  read -p "   ãƒ—ãƒªã‚»ãƒƒãƒˆå: " PRESET_NAME
  
  # ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆID
  echo ""
  echo "ðŸ“Š ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆID"
  echo "   URLã® https://docs.google.com/spreadsheets/d/{ã“ã“}/edit ã®éƒ¨åˆ†"
  read -p "   Sheet ID: " SHEET_ID
  
  # ã‚·ãƒ¼ãƒˆå
  echo ""
  echo "ðŸ“„ ã‚·ãƒ¼ãƒˆåï¼ˆæ›¸ãè¾¼ã¿å…ˆã®ã‚·ãƒ¼ãƒˆåï¼‰"
  read -p "   ã‚·ãƒ¼ãƒˆå [Raw_Lã‚¹ãƒ†ãƒƒãƒ—]: " SHEET_NAME
  SHEET_NAME=${SHEET_NAME:-Raw_Lã‚¹ãƒ†ãƒƒãƒ—}
  
  # settings.jsonã‚’ç”Ÿæˆ
  cat > config/settings.json << EOF
{
  "clients": [
    {
      "name": "${CLIENT_NAME}",
      "exporterUrl": "${EXPORTER_URL}",
      "presetName": "${PRESET_NAME}",
      "sheetId": "${SHEET_ID}",
      "sheetName": "${SHEET_NAME}"
    }
  ],
  "options": {
    "timeout": 60000,
    "retryCount": 3,
    "retryDelay": 5000,
    "headless": true,
    "slowMo": 100,
    "waitForNetworkIdle": true,
    "screenshotOnError": true,
    "stopOnError": false,
    "cleanupDownloads": true
  },
  "logging": {
    "level": "info",
    "maxFiles": 30,
    "maxSize": "10m"
  }
}
EOF
  
  echo ""
  echo -e "${GREEN}âœ… config/settings.json ã‚’ä½œæˆã—ã¾ã—ãŸ${NC}"
fi

echo ""
echo -e "${GREEN}âœ… Step 3 å®Œäº†${NC}"
echo ""

# ========================================
# Step 4: åˆå›žãƒ­ã‚°ã‚¤ãƒ³
# ========================================
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${GREEN}Step 4/5: Lã‚¹ãƒ†ãƒƒãƒ— åˆå›žãƒ­ã‚°ã‚¤ãƒ³${NC}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

if [ -d ".browser-data" ]; then
  echo -e "${YELLOW}âš ï¸  ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ãŒæ—¢ã«ä¿å­˜ã•ã‚Œã¦ã„ã¾ã™${NC}"
  read -p "å†ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã™ã‹ï¼Ÿ (y/n): " relogin
  if [[ $relogin != "y" && $relogin != "Y" ]]; then
    echo "æ—¢å­˜ã®ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ã‚’ä½¿ç”¨ã—ã¾ã™"
    echo ""
    echo -e "${GREEN}âœ… Step 4 å®Œäº†${NC}"
    echo ""
    # Step 5ã¸
    read -p "Enter ã‚’æŠ¼ã—ã¦æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã¸..."
  else
    rm -rf .browser-data
  fi
fi

if [ ! -d ".browser-data" ]; then
  echo "ã“ã‚Œã‹ã‚‰ãƒ–ãƒ©ã‚¦ã‚¶ãŒé–‹ãã¾ã™"
  echo ""
  echo "ðŸ“ æ‰‹é †:"
  echo "   1. ãƒ–ãƒ©ã‚¦ã‚¶ã§Lã‚¹ãƒ†ãƒƒãƒ—ã®ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ãŒé–‹ãã¾ã™"
  echo "   2. æ‰‹å‹•ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„"
  echo "   3. ãƒ­ã‚°ã‚¤ãƒ³ãŒå®Œäº†ã—ãŸã‚‰ã€ã“ã®ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã«æˆ»ã£ã¦ Enter ã‚’æŠ¼ã—ã¦ãã ã•ã„"
  echo ""
  read -p "æº–å‚™ãŒã§ããŸã‚‰ Enter ã‚’æŠ¼ã—ã¦ãã ã•ã„..."
  
  echo ""
  npm run setup
  
  if [ $? -ne 0 ]; then
    echo ""
    echo -e "${RED}âŒ ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ${NC}"
    echo "ã‚‚ã†ä¸€åº¦è©¦ã—ã¦ãã ã•ã„: npm run setup"
    exit 1
  fi
fi

echo ""
echo -e "${GREEN}âœ… Step 4 å®Œäº†${NC}"
echo ""

# ========================================
# Step 5: å‹•ä½œç¢ºèª
# ========================================
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${GREEN}Step 5/5: å‹•ä½œç¢ºèª${NC}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

read -p "ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ (y/n): " test_run

if [[ $test_run == "y" || $test_run == "Y" ]]; then
  echo ""
  echo "ðŸš€ ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚’é–‹å§‹ã—ã¾ã™..."
  echo ""
  
  npm start
  
  if [ $? -eq 0 ]; then
    echo ""
    echo -e "${GREEN}âœ… ãƒ†ã‚¹ãƒˆå®Ÿè¡ŒæˆåŠŸï¼${NC}"
  else
    echo ""
    echo -e "${RED}âŒ ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã«å¤±æ•—ã—ã¾ã—ãŸ${NC}"
    echo ""
    echo "ðŸ’¡ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°:"
    echo "   1. logs/ ãƒ•ã‚©ãƒ«ãƒ€ã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’ç¢ºèª"
    echo "   2. config/settings.json ã®è¨­å®šã‚’ç¢ºèª"
    echo "   3. ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®æ¨©é™ã‚’ç¢ºèª"
  fi
fi

echo ""
echo -e "${GREEN}âœ… Step 5 å®Œäº†${NC}"
echo ""

# ========================================
# å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
# ========================================
echo ""
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘                                                            â•‘"
echo "â•‘                  ðŸŽ‰ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†ï¼                      â•‘"
echo "â•‘                                                            â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo -e "${GREEN}æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:${NC}"
echo ""
echo "  ${BLUE}1. å®šæœŸå®Ÿè¡Œã‚’è¨­å®š${NC}"
echo "     ./setup-cron.sh"
echo ""
echo "  ${BLUE}2. æ‰‹å‹•å®Ÿè¡Œ${NC}"
echo "     npm start"
echo ""
echo "  ${BLUE}3. ãƒ­ã‚°ç¢ºèª${NC}"
echo "     npm run logs"
echo "     tail -f logs/cron.log"
echo ""
echo "  ${BLUE}4. è¿½åŠ ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’è¨­å®š${NC}"
echo "     config/settings.json ã‚’ç·¨é›†"
echo ""
echo -e "${YELLOW}ðŸ’¡ ãƒ˜ãƒ«ãƒ—:${NC} README.md ã‚’å‚ç…§"
echo ""